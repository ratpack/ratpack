# retrofit

The `ratpack-retrofit2` extension provides integration for declarative HTTP clients with the [retrofit2](http://square.github.io/retrofit) library.

The retrofit library allows for representing HTTP APIs via a type-safe interface.
This allows application code to interact with APIs using typed objects and abstracting the HTTP constructs.

Retrofit clients generated using the [`RatpackRetrofit`](api/ratpack/retrofit/RatpackRetrofit.html) class are backed with
Ratpack's [`HttpClient`](api/ratpack/http/client/HttpClient.html) and are capable of interfacing with 
Ratpack's [`Promise`](api/ratpack/exec/Promise.html) construct as a return type.


## Usage

The [`RatpackRetrofit.client(URI endpoint)`](api/ratpack/retrofit/RatpackRetrofit.html#client-java.net.URI-) and 
[`RatpackRetrofit.client(String endpoint)`](api/ratpack/retrofit/RatpackRetrofit.html#client-java.lang.String-)
methods provide the entry point for creating API clients.

The provided `URI` or `String` specifies the base URL for all clients generated by the `Builder`.

The underlying [`Retrofit.Builder`](https://square.github.io/retrofit/2.x/retrofit/retrofit2/Retrofit.Builder.html) can be configured
with the [`RatpackRetrofit.Builder.configure(Action<? super Retrofit.Builder> spec)`](api/ratpack/retrofit/RatpackRetrofit.Builder.html#configure-ratpack.func.Action-) method.

Once configured, the client is constructed by calling [`build(java.lang.Class api)`](api/ratpack/retrofit/RatpackRetrofit.Builder.html#build-java.lang.Class-)
with the api interface. 
This method returns a generated instance of the interface that will issue the HTTP requests and adapt the responses to the
configured return type.

```language-java
import ratpack.exec.Promise;
import ratpack.http.client.ReceivedResponse;
import ratpack.retrofit.RatpackRetrofit;
import ratpack.server.PublicAddress;
import ratpack.test.embed.EmbeddedApp;
import retrofit2.http.GET;

import static org.junit.Assert.*;

public class Example {

  public static interface HelloApi {
    @GET("hi") Promise<String> hello();
  }

  public static void main(String... args) throws Exception {
    EmbeddedApp.of(s -> s
      .handlers(chain -> {
        chain.get(ctx -> {
          PublicAddress address = ctx.get(PublicAddress.class);
          
          HelloApi api = RatpackRetrofit
            .client(address.get())
            .build(HelloApi.class);
            
          ctx.render(api.hello());
        });
        chain.get("hi", ctx -> ctx.render("hello"));
      })
    ).test(httpClient -> {
      ReceivedResponse response = httpClient.get();
      assertEquals("hello", response.getBody().getText());
    });
  }
}
```

## Creating multiple API implementations

Many APIs may be represented using distinct interfaces for different capabilities. 
To create multiple clients, the underlying [`Retrofit`](https://square.github.io/retrofit/2.x/retrofit/retrofit2/Retrofit.html) class can be obtained.

```language-java
import ratpack.exec.Promise;
import ratpack.http.client.ReceivedResponse;
import ratpack.retrofit.RatpackRetrofit;
import ratpack.server.PublicAddress;
import ratpack.test.embed.EmbeddedApp;
import retrofit2.http.GET;
import retrofit2.Retrofit;

import static org.junit.Assert.*;

  
public class Example {

  public static interface HelloApi {
    @GET("hi") Promise<String> hello();
  }
  
  public static interface GoodbyeApi {
    @GET("bye") Promise<String> bye();
  }

  public static void main(String... args) throws Exception {
    EmbeddedApp.of(s -> s
      .handlers(chain -> {
        chain.get(ctx -> {
          PublicAddress address = ctx.get(PublicAddress.class);
          
          Retrofit retrofit = RatpackRetrofit
            .client(address.get())
            .retrofit();
            
          HelloApi hiApi = retrofit.create(HelloApi.class);
          GoodbyeApi byeApi = retrofit.create(GoodbyeApi.class);
            
          ctx.render(hiApi.hello().right(byeApi.bye()).map(p -> p.left() + " and " + p.right()));
        });
        chain.get("hi", ctx -> ctx.render("hello"));
        chain.get("bye", ctx -> ctx.render("goodbye"));
      })
    ).test(httpClient -> {
      assertEquals("hello and goodbye", httpClient.getText());
    });
  }
}
```

## Using Retrofit Converters

By default, `ratpack-retrofit2` registers the [`ScalarsConverterFactory`](http://square.github.io/retrofit/2.x/converter-scalars/retrofit2/converter/scalars/ScalarsConverterFactory.html).
This allows for API responses to be converted into Java `String`, primitives and their box types.

If the remote API is responding in JSON, then the [`JacksonConverterFactory`](http://square.github.io/retrofit/2.x/converter-jackson/retrofit2/converter/jackson/JacksonConverterFactory.html) must be registered.

```language-java
import com.fasterxml.jackson.databind.ObjectMapper;
import ratpack.exec.Promise;
import ratpack.http.client.ReceivedResponse;
import ratpack.retrofit.RatpackRetrofit;
import ratpack.server.PublicAddress;
import ratpack.test.embed.EmbeddedApp;
import retrofit2.converter.jackson.JacksonConverterFactory;
import retrofit2.http.GET;
import retrofit2.Retrofit;

import java.util.List;

import static ratpack.jackson.Jackson.json;
import static org.junit.Assert.*;

  
public class Example {

  public static interface NameApi {
    @GET("names") Promise<List<String>> names();
  }

  public static void main(String... args) throws Exception {
    EmbeddedApp.of(s -> s
      .handlers(chain -> {
        chain.get(ctx -> {
          PublicAddress address = ctx.get(PublicAddress.class);
          
          NameApi api = RatpackRetrofit
            .client(address.get())
            .configure(b -> 
              b.addConverterFactory(
                JacksonConverterFactory.create(
                  ctx.get(ObjectMapper.class)
                )
              )
            )
            .build(NameApi.class);
            
          api.names().then(nameList -> ctx.render(json(nameList)));  
        });
        chain.get("names", ctx -> ctx.render(json(new String[]{"John", "Jane"})));
      })
    ).test(httpClient -> {
      assertEquals("[\"John\",\"Jane\"]", httpClient.getText());
    });
  }
}
```



